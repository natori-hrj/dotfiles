# Google Cloud Run デプロイガイド

このガイドでは、GitHub ActionsでGoogle Cloud Runに自動デプロイする方法を説明します。

## 前提条件

- Google Cloud Platform アカウント
- GitHub リポジトリ
- `gcloud` CLI（ローカルでテストする場合）

## Google Cloud の設定

### 1. プロジェクトの作成

```bash
# プロジェクトIDを設定（任意の名前）
export PROJECT_ID="your-project-id"

# プロジェクトを作成
gcloud projects create $PROJECT_ID

# プロジェクトを選択
gcloud config set project $PROJECT_ID
```

### 2. 必要なAPIの有効化

```bash
# Cloud Run API
gcloud services enable run.googleapis.com

# Artifact Registry API
gcloud services enable artifactregistry.googleapis.com

# Cloud Build API
gcloud services enable cloudbuild.googleapis.com
```

### 3. Artifact Registryリポジトリの作成

```bash
# リージョンを設定（東京）
export REGION="asia-northeast1"

# Docker リポジトリを作成
gcloud artifacts repositories create portfolio \
  --repository-format=docker \
  --location=$REGION \
  --description="Portfolio Docker repository"
```

### 4. サービスアカウントの作成

```bash
# サービスアカウントを作成
gcloud iam service-accounts create github-actions \
  --description="Service account for GitHub Actions" \
  --display-name="GitHub Actions"

# 必要な権限を付与
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"

# JSONキーを生成
gcloud iam service-accounts keys create key.json \
  --iam-account=github-actions@$PROJECT_ID.iam.gserviceaccount.com
```

## GitHub Secretsの設定

GitHubリポジトリの Settings > Secrets and variables > Actions で以下のシークレットを追加：

1. **GCP_PROJECT_ID**
   - Value: あなたのGCPプロジェクトID

2. **GCP_SA_KEY**
   - Value: 上記で生成した `key.json` の内容全体

## デプロイ方法

### 自動デプロイ

`main` ブランチにプッシュすると自動的にデプロイされます：

```bash
git add .
git commit -m "Deploy to Cloud Run"
git push origin main
```

### 手動デプロイ

GitHubのActionsタブから「Deploy to Cloud Run」ワークフローを手動実行できます。

## ローカルでのDockerテスト

```bash
# イメージをビルド
docker build -t portfolio .

# コンテナを実行
docker run -p 3000:3000 portfolio

# ブラウザで http://localhost:3000 にアクセス
```

## 設定のカスタマイズ

### リージョンの変更

`.github/workflows/deploy.yml` の `REGION` を変更：

```yaml
env:
  REGION: us-central1  # または他のリージョン
```

### リソース設定の調整

`deploy.yml` のCloud Runデプロイ設定を調整：

```yaml
--memory 1Gi          # メモリを増やす
--cpu 2              # CPUを増やす
--min-instances 1    # 常に1インスタンス起動
--max-instances 100  # 最大インスタンス数を増やす
```

## コスト最適化

- **最小インスタンス数**: `0` に設定してアイドル時のコストを削減
- **メモリ**: 必要最小限に設定（デフォルト: 512Mi）
- **CPU**: 必要に応じて調整（デフォルト: 1）
- **リクエストタイムアウト**: 適切に設定

## トラブルシューティング

### デプロイが失敗する場合

1. GitHub Actionsのログを確認
2. GCP権限を確認
3. Artifact Registryにイメージがプッシュされているか確認

```bash
# イメージ一覧を確認
gcloud artifacts docker images list $REGION-docker.pkg.dev/$PROJECT_ID/portfolio
```

### Cloud Runサービスのログ確認

```bash
# ログを確認
gcloud run services logs read portfolio --region=$REGION --limit=50
```

### サービスの削除

```bash
# Cloud Runサービスを削除
gcloud run services delete portfolio --region=$REGION

# Artifact Registryリポジトリを削除
gcloud artifacts repositories delete portfolio --location=$REGION
```

## セキュリティのベストプラクティス

1. **サービスアカウントキーの管理**
   - GitHub Secretsに安全に保存
   - 定期的にローテーション
   - 必要最小限の権限のみ付与

2. **環境変数**
   - 機密情報はGitHub SecretsまたはSecret Managerを使用
   - Cloud Runの環境変数として設定

3. **認証**
   - 本番環境では `--allow-unauthenticated` を慎重に使用
   - 必要に応じてCloud Run IAMで認証を設定

## 参考リンク

- [Cloud Run ドキュメント](https://cloud.google.com/run/docs)
- [GitHub Actions ドキュメント](https://docs.github.com/ja/actions)
- [Next.js デプロイメント](https://nextjs.org/docs/deployment)
