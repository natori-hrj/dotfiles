# GitHub Actions デプロイのトラブルシューティング

## エラー: "must specify exactly one of workload_identity_provider or credentials_json"

### 原因
GitHub Secretsが正しく設定されていないか、ワークフローに渡されていません。

### 解決方法（チェックリスト）

#### ステップ 1: GitHub Secretsの確認

1. GitHubリポジトリにアクセス
2. **Settings** タブをクリック
3. 左サイドバーの **Secrets and variables** > **Actions** をクリック
4. 以下のシークレットが存在するか確認：
   - `GCP_PROJECT_ID`
   - `GCP_SA_KEY`

#### ステップ 2: シークレットの値を確認

**GCP_PROJECT_ID:**
```bash
# あなたのGCPプロジェクトIDを確認
gcloud config get-value project
```

**GCP_SA_KEY:**
```bash
# key.jsonの内容全体を確認（{}を含む）
cat key.json
```

以下のようなJSON形式になっているはずです：
```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  ...
}
```

#### ステップ 3: シークレットを再設定

1. GitHub Secretsページで既存のシークレットを削除（あれば）
2. **New repository secret** をクリック
3. シークレットを追加：

**GCP_PROJECT_ID:**
- Name: `GCP_PROJECT_ID`
- Value: あなたのGCPプロジェクトID（例: `my-portfolio-123456`）

**GCP_SA_KEY:**
- Name: `GCP_SA_KEY`
- Value: `key.json` の**内容全体**をコピー＆ペースト
  ```bash
  # macOS/Linux
  cat key.json | pbcopy  # または cat key.json してコピー

  # Windows
  type key.json | clip
  ```

#### ステップ 4: ワークフローを再実行

1. GitHubリポジトリの **Actions** タブ
2. 失敗したワークフローをクリック
3. **Re-run all jobs** をクリック

### よくある間違い

❌ **間違い**: key.jsonのファイルパスを入力
```
Value: /path/to/key.json  ← これは間違い
```

✅ **正しい**: key.jsonの内容全体を入力
```json
{
  "type": "service_account",
  ...
}
```

❌ **間違い**: シークレット名のスペルミス
```yaml
credentials_json: ${{ secrets.GCP_SA_KEYS }}  ← 末尾にSがある
```

✅ **正しい**:
```yaml
credentials_json: ${{ secrets.GCP_SA_KEY }}
```

## その他のエラー

### "Permission denied" エラー

サービスアカウントに適切な権限がない場合：

```bash
export PROJECT_ID="your-project-id"

# 必要な権限を付与
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"

gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:github-actions@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"
```

### Docker buildエラー

ローカルでビルドをテスト：

```bash
# Dockerfileの構文エラーをチェック
docker build -t portfolio-test .

# エラーがある場合、ログを確認
```

### Artifact Registryへのpushエラー

1. リポジトリが存在するか確認：
```bash
gcloud artifacts repositories list --location=asia-northeast1
```

2. リポジトリが存在しない場合は作成：
```bash
gcloud artifacts repositories create portfolio \
  --repository-format=docker \
  --location=asia-northeast1
```

## デバッグのヒント

### GitHub Actionsログの確認

1. GitHubリポジトリの **Actions** タブ
2. 失敗したワークフローをクリック
3. 各ステップを展開して詳細なログを確認

### ローカルでのテスト

```bash
# Dockerビルドをローカルでテスト
docker build -t portfolio .

# コンテナを実行
docker run -p 3000:3000 portfolio

# ブラウザで http://localhost:3000 を確認
```

## まだ解決しない場合

1. [DEPLOYMENT.md](./DEPLOYMENT.md) を最初から確認
2. GCPプロジェクトの設定を確認
3. GitHub Actionsのログ全体をコピーして確認

## 参考リンク

- [GitHub Actions Secrets](https://docs.github.com/ja/actions/security-guides/encrypted-secrets)
- [Google Cloud Authentication](https://github.com/google-github-actions/auth)
- [Cloud Run Documentation](https://cloud.google.com/run/docs)
